generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  FREE
  PRO
}

enum Tone {
  strict
  balanced
  light
}

enum CoachMessageKind {
  nudge
  brief
  mirror
  letter
  intel // NEW - Daily Intel
  exam_alert // NEW - Exam countdown alerts
  mastery_alert // NEW - Weak topic push
}

model User {
  id           String  @id @default(cuid())
  email        String? @unique
  tz           String  @default("Europe/London")
  tone         Tone    @default(balanced)
  intensity    Int     @default(2)
  consentRoast Boolean @default(false)
  safeWord     String?
  plan         Plan    @default(FREE)

  // Study OS specific
  mentorId       String? // AI personality (marcus, drill, etc)
  fcmToken       String? // Firebase Cloud Messaging token for push
  nudgesEnabled  Boolean @default(true)
  intelEnabled   Boolean @default(true) // Daily Intel generation
  studyReminders Boolean @default(true)

  // Study preferences
  grade         String? // "Year 11", "Sophomore", etc
  studyGoals    String[] @default([])
  learningStyle String? // "visual", "auditory", "kinesthetic"
  weeklyGoal    Int      @default(600) // minutes per week (10 hours)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Study OS
  events          Event[]
  userFacts       UserFacts?
  exams           Exam[]
  studySessions   StudySession[]
  topicMastery    TopicMastery[]
  projects        Project[]
  scannedProblems ScannedProblem[]
  videoSummaries  VideoSummary[]
  studyTargets    StudyTarget[]
  coachMessages   CoachMessage[]
}

// ============================================================
// CORE SYSTEM MODELS (KEEP - Infrastructure)
// ============================================================

model Event {
  id        String   @id @default(cuid())
  userId    String
  ts        DateTime @default(now())
  type      String
  payload   Json     @default("{}")
  embedding Bytes?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, ts])
  @@index([type])
}

model UserFacts {
  userId    String   @id
  json      Json     @default("{}")
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VoiceCache {
  id        String   @id
  text      String
  voice     String
  url       String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model CoachMessage {
  id        String           @id @default(cuid())
  userId    String
  kind      CoachMessageKind
  title     String
  body      String           @db.Text
  meta      Json?
  createdAt DateTime         @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, kind])
  @@index([userId, createdAt])
}

// ============================================================
// STUDY OS MODELS (NEW)
// ============================================================

// üéì EXAMS
model Exam {
  id          String   @id @default(cuid())
  userId      String
  subject     String
  topic       String? // "Organic Chemistry", "Cell Division", etc
  date        DateTime
  weight      Int      @default(100) // % of final grade
  targetGrade String? // "A", "A+", "90%"
  icon        String   @default("üìö")

  // Computed fields (updated by intelligence service)
  daysRemaining Int     @default(0)
  threatLevel   String  @default("MEDIUM") // CRITICAL, HIGH, MEDIUM, LOW
  progress      Int     @default(0) // 0-100% prep completion
  prediction    String? // "72%", "B+", predicted outcome

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, date])
  @@index([threatLevel])
}

// üìö STUDY SESSIONS
model StudySession {
  id            String  @id @default(cuid())
  userId        String
  subject       String
  topic         String?
  minutes       Int
  effectiveness Int? // 1-10 self-rating (optional)
  notes         String? @db.Text

  // Auto-calculated by intelligence service
  masteryDelta Float? // change in mastery score after session
  focusScore   Int? // calculated from duration/effectiveness

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([subject])
}

// üéØ TOPIC MASTERY TRACKING
model TopicMastery {
  id         String @id @default(cuid())
  userId     String
  subject    String
  topic      String
  score      Int    @default(0) // 0-100
  confidence Int    @default(50) // how confident they feel (1-100)

  lastStudied   DateTime?
  totalMinutes  Int       @default(0)
  sessionsCount Int       @default(0)

  // Pattern tracking (derived from sessions)
  peakTimes String[] @default([]) // ["9am-11am", "2pm-4pm"]
  struggles String[] @default([]) // common mistakes/weak areas

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, subject, topic])
  @@index([userId])
  @@index([userId, score])
}

// ü§ñ PROJECTS (Canvas/Neural Tab - Chat Sessions)
model Project {
  id          String  @id @default(cuid())
  userId      String
  name        String
  emoji       String  @default("üìö")
  description String? @db.Text
  pinned      Boolean @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastActive DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([userId, lastActive])
}

// üí¨ MESSAGES (Chat History per Project)
model Message {
  id        String @id @default(cuid())
  projectId String
  role      String // "user" | "assistant"
  content   String @db.Text

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, createdAt])
}

// üîç SCANNED PROBLEMS (OCR + AI Solve)
model ScannedProblem {
  id      String  @id @default(cuid())
  userId  String
  subject String?
  topic   String?

  imageUrl    String? // S3 URL if stored
  ocrText     String  @db.Text
  solution    String  @db.Text
  explanation String  @db.Text

  saved Boolean @default(false)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// üé• VIDEO SUMMARIES
model VideoSummary {
  id      String  @id @default(cuid())
  userId  String
  title   String
  url     String?
  subject String?
  topic   String?

  transcript String?  @db.Text
  summary    String   @db.Text
  keyPoints  String[] @default([])

  saved Boolean @default(false)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// üéØ STUDY TARGETS (User-created from Flutter FAB)
model StudyTarget {
  id          String  @id @default(cuid())
  userId      String
  title       String
  description String? @db.Text
  emoji       String  @default("üéØ")

  startDate DateTime
  endDate   DateTime

  completed   Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, completed])
}
